<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="fragments/layout.html :: head('배출신청')">
    <meta charset="UTF-8">
    <title>대형 폐기물 배출 신청</title>
</head>

<body>
    <nav class="py-2 bg-light border-bottom"  th:replace="/fragments/layout.html :: menu">
    </nav>
    <header class="py-3 mb-4 border-bottom" th:replace="/fragments/layout.html :: header">
    </header>

    <div class="list">
<!--        <div class="search">-->
<!--            <form method="get">-->
<!--    &lt;!&ndash;            <input name="searchKeyword" type="text" />&ndash;&gt;-->
<!--                <input th:value="${param.searchValue}" type="sear" name="searchKeyword" placeholder="검색어 입력"/>-->
<!--                <button type="submit">검색</button>-->
<!--            </form>-->

            <table>
                <thead>
                <tr>
                    <th>번호</th>
                    <th>
                        폐기물명
                    </th>
                    <th>
                        가격
                    </th>
                    <th>
                        규격
                    </th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="x : ${list}">
                    <td th:text="${x.itemId}"></td>
                    <td th:text="${x.itemName}"></td>
                    <td th:text="${x.price}"></td>
                    <td th:text="${x.itemDetail}"></td>
                    <td>
                        <label class="checkbox-inline">
                            <button type="button" class="select-button"
                                    th:data-id="${x.itemId}"
                                    th:data-name="${x.itemName}"
                                    th:data-detail=" ${x.itemDetail}"
                                    th:data-price="${x.price}">
                                선택
                            </button>
                        </label>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="order">
        <form id="orderForm" method="post">
            <div>
                <label>이름 <input type="text" name="orderUserName" placeholder="이름"
                                 required/></label>
            </div>
            <div>
                <input type="text" id="postcode" placeholder="우편번호">
                <input type="button" onclick="execDaumPostcode()" value="우편번호 찾기"><br>
                <input type="text" id="address1" placeholder="주소"><br>
                <input type="text" id="address2" placeholder="상세주소">
                <input type="text" id="address3" placeholder="참고항목">
            </div>
            <div>
                <input type="tel" name="orderUserPhone" placeholder="전화번호" required/>
            </div>
            <div>
                <label>배출예정시간<input type="datetime-local" name="disposeDatetime"
                                    required/></label>
            </div>
            <select name="districtName">
                <option value="행정동" selected>행정동</option>
                <option value="월계1동">월계1동</option>
                <option value="월계2동">월계2동</option>
                <option value="월계3동">월계3동</option>
                <option value="공릉1동">공릉1동</option>
                <option value="공릉2동">공릉2동</option>
                <option value="하계1동">하계1동</option>
                <option value="하계2동">하계2동</option>
                <option value="중계본동">중계본동</option>
                <option value="중계1동">중계1동</option>
                <option value="중계2.3동">중계2.3동</option>
                <option value="중계4동">중계4동</option>
                <option value="상계1동">상계1동</option>
                <option value="상계2동">상계2동</option>
                <option value="상계3.4동">상계3.4동</option>
                <option value="상계5동">상계5동</option>
                <option value="상계6.7동">상계6.7동</option>
                <option value="상계8동">상계8동</option>
                <option value="상계9동">상계9동</option>
                <option value="상계10동">상계10동</option>
            </select>

            <div class="result">
                <table id="resultTable">
                    <thead>
                    <tr>
                        <th>폐기물명</th>
                        <th>규격</th>
                        <th>수량</th>
                        <th>가격</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div>
                <button id="submitButton" type="submit">신청하기</button>
            </div>
        </form>
    </div>

<script>
    (function () {
        checkWaste();

        function checkWaste() {
            let selectButtons = document.getElementsByClassName("select-button");
            for (let i = 0; i < selectButtons.length; i++) {
                selectButtons[i].addEventListener("click", function () {
                    const resultTable = document.getElementById("resultTable");
                    const rows = resultTable.querySelectorAll("tr[data-id='" + this.dataset.id + "']");

                    let isRowExist = false;
                    for (let j = 0; j < rows.length; j++) {
                        if (rows[j]) {
                            isRowExist = true;
                        }
                    }

                    if (isRowExist) {
                        const existRow = resultTable.querySelector("tr[data-id='" + this.dataset.id + "']");
                        let count = existRow.querySelector(".count-cell");
                        let price = existRow.querySelector(".price-cell");

                        count.innerText = Number(count.innerText) + 1;
                        price.innerText = Number(price.innerText) + Number(this.dataset.price);
                    } else {
                        const newRow = resultTable.querySelector("tbody").insertRow();
                        newRow.dataset.id = this.dataset.id;
                        const newCell0 = newRow.insertCell(0);
                        const newCell1 = newRow.insertCell(1);
                        const newCell2 = newRow.insertCell(2);
                        const newCell3 = newRow.insertCell(3);

                        newCell0.innerText = this.dataset.name;
                        newCell0.classList.add("name-cell");
                        newCell1.innerText = this.dataset.detail ?? ""; // undefined 나 null 값은 공백 처리
                        newCell1.classList.add("detail-cell");
                        newCell2.innerText = 1;
                        newCell2.classList.add("count-cell");
                        newCell3.innerText = this.dataset.price;
                        newCell3.classList.add("price-cell");
                    }
                })
            }
        }
    })();

    (function () {
        submitForm();

        function submitForm() {
            let submitButton = document.getElementById("submitButton");

            submitButton.addEventListener("click", function (e) {
                e.preventDefault();

                let resultRows = document.getElementById("resultTable").querySelectorAll("tbody tr");

                for (let i = 0; i < resultRows.length; i++) {
                    let row = resultRows[i];

                    row.querySelectorAll("input").forEach(x => x.remove());

                    const inputId = document.createElement("input");
                    inputId.type = "hidden";
                    inputId.name = "resultList[" + i + "].wasteId";
                    inputId.value = row.dataset.id;
                    row.append(inputId);

                    const inputName = document.createElement("input");
                    inputName.type = "hidden";
                    inputName.name = "resultList[" + i + "].wasteName";
                    inputName.value = row.querySelector(".name-cell").innerText;
                    row.append(inputName);

                    const inputDetail = document.createElement("input");
                    inputDetail.type = "hidden";
                    inputDetail.name = "resultList[" + i + "].wasteDetail";
                    inputDetail.value = row.querySelector(".detail-cell").innerText;
                    row.append(inputDetail);

                    const inputCount = document.createElement("input");
                    inputCount.type = "hidden";
                    inputCount.name = "resultList[" + i + "].count";
                    inputCount.value = row.querySelector(".count-cell").innerText;
                    row.append(inputCount);

                    const inputPrice = document.createElement("input");
                    inputPrice.type = "hidden";
                    inputPrice.name = "resultList[" + i + "].price";
                    inputPrice.value = row.querySelector(".price-cell").innerText;
                    row.append(inputPrice);
                }

                let orderForm = document.getElementById("orderForm");
                orderForm.submit();
            })
        }
    })();
</script>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                var addr = ''; // 주소 변수
                var extraAddr = ''; // 참고항목 변수

                //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                    addr = data.roadAddress;
                } else { // 사용자가 지번 주소를 선택했을 경우(J)
                    addr = data.jibunAddress;
                }

                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if(data.userSelectedType === 'R'){
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    document.getElementById("address3").value = extraAddr;

                } else {
                    document.getElementById("address3").value = '';
                }

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById('postcode').value = data.zonecode;
                document.getElementById("address1").value = addr;
                // 커서를 상세주소 필드로 이동한다.
                document.getElementById("address2").focus();
            }
        }).open();
    }
</script>

<!--<script>-->
<!--    function getWaste(num) {-->
<!--        // var juso_keyword = $("#txt_juso_keyword").val();-->

<!--        var pageSize = 10;-->
<!--        var totalPages = 0;-->
<!--        var curPage = num;-->
<!--        $("input[name='currentPage']").val(curPage); // 페이지 바꿔주기-->

<!--        // $.ajax({-->
<!--        //     url :"https://www.juso.go.kr/addrlink/addrLinkApiJsonp.do"  // 인터넷망-->
<!--        //     ,type:"post"-->
<!--        //     ,data:$("#juso_frm").serialize()-->
<!--        //     ,dataType:"jsonp"-->
<!--        //     ,crossDomain:true-->
<!--        //     ,success:function(jsonStr){-->
<!--        //         var errCode = jsonStr.results.common.errorCode;-->
<!--        //         var errDesc = jsonStr.results.common.errorMessage;-->
<!--        //         var totalCount = jsonStr.results.common.totalCount;-->
<!--        //         if(errCode != "0"){-->
<!--        //             console.log(errCode+"="+errDesc);-->
<!--        //             alertWarning(errorTitle, errDesc, btnText);-->
<!--        //             //closepop();-->
<!--        //         }else{-->
<!--        //             if(jsonStr != null){-->
<!--        //                 makeListJson(jsonStr);-->

<!--        // 페이징처리-->
<!--        if (totalCount != 0) {-->
<!--            totalPages = Math.ceil(totalCount / pageSize);-->
<!--            // pageLink(현재페이지, 전체페이지, 호출할 함수이름)-->
<!--            var htmlStr = pageLink(curPage, totalPages, "getWaste");-->
<!--            // common.js - pageLink-->
<!--            $("#div_paginate").html(htmlStr);-->
<!--        } else {-->
<!--            //alert("검색되는 주소없음")-->
<!--        }-->
<!--    }-->


<!--            // ,error: function(xhr,status, error){-->
<!--            //     alertWarning(errorTitle, "주소 에러발생", btnText);-->
<!--            // }-->
<!-- //       });-->
<!--    //     }-->
<!--    function pageLink(curPage, totalPages, funName) {-->
<!--        var pageUrl = "";-->

<!--        var pageLimit = 5;-->
<!--        var startPage = parseInt((curPage - 1) / pageLimit) * pageLimit + 1;-->
<!--        var endPage = startPage + pageLimit - 1;-->

<!--        if (totalPages < endPage) {-->
<!--            endPage = totalPages;-->
<!--        }-->

<!--        var nextPage = endPage + 1;-->
<!--        //console.log(curPage,"curPage,",startPage,"startPage,",endPage,"endPage,",nextPage,"nextPage")-->

<!--        //맨 첫 페이지-->
<!--        if (curPage > 1 && pageLimit < curPage) {-->
<!--            pageUrl += "<a class='page first' href='javascript:" + funName + "(1);'><i class='fas fa-angle-double-left'></a>";-->
<!--        }-->
<!--        //이전 페이지-->
<!--        if (curPage > pageLimit) {-->
<!--            pageUrl += " <a class='page prev' href='javascript:" + funName + "(" + (startPage == 1 ? 1 : startPage - 1) + ");'><i class='fas fa-angle-left'></a>";-->
<!--        }-->
<!--        //~pageLimit 맞게 페이지 수 보여줌-->
<!--        for (var i = startPage; i <= endPage; i++) {-->
<!--            //현재페이지면 진하게 표시-->
<!--            if (i == curPage) {-->
<!--                pageUrl += " <a href='#'><strong>" + i + "</strong></a>"-->
<!--            } else {-->
<!--                pageUrl += " <a href='javascript:" + funName + "(" + i + ");'> " + i + " </a>";-->
<!--            }-->
<!--        }-->
<!--        //다음 페이지-->
<!--        if (nextPage <= totalPages) {-->
<!--            pageUrl += "<a class='page next' href='javascript:" + funName + "(" + (nextPage < totalPages ? nextPage : totalPages) + ");'><i class='fas fa-angle-right'></a>";-->
<!--        }-->
<!--        //맨 마지막 페이지-->
<!--        if (curPage < totalPages && nextPage < totalPages) {-->
<!--            pageUrl += "<a class='page last' href='javascript:" + funName + "(" + totalPages + ");'><i class='fas fa-angle-double-right'></a>";-->
<!--        }-->
<!--        //console.log(pageUrl);-->

<!--        return pageUrl;-->
<!--    }-->
<!--
&lt;!&ndash;</script>&ndash;&gt;
<script>

    let totalData; //총 데이터 수
    let dataPerPage; //한 페이지에 나타낼 글 수
    let pageCount = 10; //페이징에 나타낼 페이지 수
    let globalCurrentPage=1; //현재 페이지
    let dataList; //표시하려하는 데이터 리스트

    $(document).ready(function () {
        //dataPerPage 선택값 가져오기
        dataPerPage = $("#dataPerPage").val();

        $.ajax({ // ajax로 데이터 가져오기
            method: "GET",
            url: "https://localhost:8080/order/waste" + data,
            dataType: "json",
            success: function (d) {
                //totalData(총 데이터 수) 구하기
                totalData = d.data.length;
                //데이터 대입
                dataList = d.data;
            }
            });

        //글 목록 표시 호출 (테이블 생성)
        displayData(1, dataPerPage);

        //페이징 표시 호출
        paging(totalData, dataPerPage, pageCount, 1);
    });

    //현재 페이지(currentPage)와 페이지당 글 개수(dataPerPage) 반영
    function displayData(currentPage, dataPerPage) {

        let chartHtml = "";

//Number로 변환하지 않으면 아래에서 +를 할 경우 스트링 결합이 되어버림..
        currentPage = Number(currentPage);
        dataPerPage = Number(dataPerPage);

        for (
            var i = (currentPage - 1) * dataPerPage;
            i < (currentPage - 1) * dataPerPage + dataPerPage;
            i++
        ) {
            chartHtml +=
                "<tr><td>" +
                dataList[i].d1 +
                "</td><td>" +
                dataList[i].d2 +
                "</td><td>" +
                dataList[i].d3 +
                "</td></tr>";
        } //dataList는 임의의 데이터임.. 각 소스에 맞게 변수를 넣어주면 됨...
        $("#dataTableBody").html(chartHtml);
    }
</script>-->

<footer class="container" th:fragment="foot">
    <p class="float-end"><a href="#">Back to top</a></p>
    <p>&copy; 2017–2023 Company, Inc. &middot; <a href="#">Privacy</a> &middot; <a href="#">Terms</a></p>
</footer>
</body>
</html>